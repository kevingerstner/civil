<!------------------------------------
    Code to be added before <head> tag
---------------------------------------->
<script>
	window.dataLayer = window.dataLayer || [];
	dataLayer.push({
		uid: localStorage.getItem("uid"),
		email: localStorage.getItem("email"),
		name: localStorage.getItem("name"),
	});
</script>

<!-- Google Tag Manager -->
<script>
	(function (w, d, s, l, i) {
		w[l] = w[l] || [];
		w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
		var f = d.getElementsByTagName(s)[0],
			j = d.createElement(s),
			dl = l != "dataLayer" ? "&l=" + l : "";
		j.async = true;
		j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
		f.parentNode.insertBefore(j, f);
	})(window, document, "script", "dataLayer", "GTM-T7NHSBT");
</script>
<!-- End Google Tag Manager -->

<!--Tooltip Styling-->
<style>
	.loader {
		display: flex;
	}

	.protected-content {
		display: none;
	}
</style>

<!-------------------------------------
    Code to be added before </body> tag
----------------------------------------->

<script type="module">
	// Import the functions you need from the SDKs you need
	import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.1/firebase-app.js";
	import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.1.1/firebase-analytics.js";
	import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.1.1/firebase-auth.js";
	//import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.1.1/firebase-functions.js";

	// Initialize Firebase
	// Your web app's Firebase configuration
	// For Firebase JS SDK v7.20.0 and later, measurementId is optional
	const firebaseConfig = {
		apiKey: "AIzaSyBoe3mHhuN3H68GZSDfjVj4-7QoiYeLN_M",
		authDomain: "civil-ed.firebaseapp.com",
		projectId: "civil-ed",
		storageBucket: "civil-ed.appspot.com",
		messagingSenderId: "252877681191",
		appId: "1:252877681191:web:f837d7fffffbf4f5591402",
		measurementId: "G-M7C700TEL8",
	};

	const app = initializeApp(firebaseConfig);
	const analytics = getAnalytics(app);
	//const functions = getFunctions();

	// Functions
	//const isUserProvisioned = httpsCallable(functions, "user-isProvisioned");

	// Elements
	let profile_component = document.getElementById("nav-username-dropdown");
	const login_component = document.getElementById("login-signup-block");
	let protectedContent = document.getElementById("protected-content");
	let loader = document.getElementById("loader");

	// Pages accessible only to provisioned users
	const privatePages = [];
	// Pages accessible only to users with accounts and verified emails
	const protectedPages = [];
	// pages that are accessibile to any user
	const authenticatedPages = [
		"/account",
		"/modules/",
		"/historical-brief",
		"/narraitves",
		"/classroom-content",
		"/activities-category",
		"/contemporary-issues",
	]; // pages that are accessible to any authenticated user

	const auth = getAuth();
	onAuthStateChanged(auth, async (user) => {
		if (user) {
			// Send info to GTM
			localStorage.setItem("uid", user.uid);
			localStorage.setItem("email", user.email);
			localStorage.setItem("name", user.displayName);

			// Manage UI
			showUserUI();
			hideLoginUI();
			setTextForAllElementsByClass("username-text", user.displayName);
			// If this is a protected route, ensure the user's email is verified
			if ((isRouteProtected() || isRoutePrivate()) && !user.emailVerified) goToRoute("/signup/verify-email");
			// // Block private content for un-provisioned users
			// if (isRoutePrivate() && !provisioned) {
			// 	goToRoute("/access-denied/awaiting-provision");
			// }
			// If all is successful, unblock protected content
			showProtectedContent();
		}
		if (!user) {
			showLoginUI();
			hideUserUI();
			// If the route is protected in any way, redirect to access denied / create account
			if (isRouteAuthenticated() || isRoutePrivate() || isRouteProtected()) goToRoute("/access-denied/create-account");
		}
	});

	function isRoutePrivate() {
		for (var i = 0; i < privatePages.length; i++) {
			if (window.location.pathname.startsWith(privatePages[i])) {
				// make sure this page isn't whitelisted to be protected
				if (!isRouteProtected()) return true;
			}
		}
		return false;
	}

	function isRouteProtected() {
		for (var i = 0; i < protectedPages.length; i++) {
			if (window.location.pathname.startsWith(protectedPages[i])) return true;
		}
		return false;
	}

	function isRouteAuthenticated() {
		for (var i = 0; i < authenticatedPages.length; i++) {
			if (window.location.pathname.startsWith(authenticatedPages[i])) return true;
		}
		return false;
	}

	/**------------------------------
	 * Helper Functions
	 **------------------------------*/

	function goToRoute(route) {
		window.location.replace(route);
	}

	// Gets all Elements with [className] and sets the innerText attribute to [text]
	function setTextForAllElementsByClass(className, text) {
		let class_elements = document.getElementsByClassName(className);
		for (var i = 0; i < class_elements.length; i++) class_elements[i].innerText = text;
	}

	/**------------------------------
	 * UI
	 **------------------------------*/

	function showUserUI() {
		if (profile_component) profile_component.style.display = "inline-block";
	}

	function hideUserUI() {
		if (profile_component) profile_component.style.display = "none";
	}

	function showLoginUI() {
		if (login_component) login_component.style.display = "inline-block";
	}

	function hideLoginUI() {
		if (login_component) login_component.style.display = "none";
	}

	/**
	 * Hide the loader and show the protected content
	 */
	function showProtectedContent() {
		if (loader && protectedContent) {
			loader.style.display = "none";
			protectedContent.style.display = "block";
		}
	}

	// Handle global Logout
	let navSignoutLink = document.getElementById("nav-signout-link");
	if (navSignoutLink) navSignoutLink.addEventListener("click", Logout, true);

	function Logout(event) {
		event.preventDefault();
		event.stopPropagation();

		signOut(auth)
			.then(() => {
				localStorage.removeItem("uid");
				window.location.replace("/");
			})
			.catch((error) => {
				console.log(error);
			});
	}
</script>
