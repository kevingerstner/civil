<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="module">
	import {
		getAuth,
		onAuthStateChanged,
		signOut,
	} from "https://www.gstatic.com/firebasejs/9.1.1/firebase-auth.js";

	// URL
	const API_URL = "https://us-central1-civil-ed.cloudfunctions.net/api";
	const LOGIN_URL = "/welcome/login";
	const CURRENT_PAGE_URL = "/pay/pricing";

	// ELEMENTS
	const monthlyText = document.getElementById("teacher-monthly");
	const yearlyText = document.getElementById("teacher-yearly");
	const priceUnitLabel = document.getElementById("teacher-price-unit-label");
	const createAccountBtn = document.getElementById("create-account-btn");
	const teacherBtn = document.querySelector("#teacher-purchase-btn");
	const bundleBtn = document.querySelector("#bundle-purchase-btn");

	// VAR
	let teacherMonthly = false;
	let checkoutData = {
		uid: localStorage.getItem("uid"),
		email: localStorage.getItem("email"),
		line_items: [
			{
				price: null,
				quantity: 1,
			},
		],
	};

	// UI
	teacherBtn.classList.remove("disabled");
	teacherBtn.innerHTML = "Start 14-Day Free Trial";
	bundleBtn.classList.remove("disabled");

	const auth = getAuth();
	onAuthStateChanged(auth, (user) => {
		if (user) {
			if (createAccountBtn) createAccountBtn.style.display = "none";
		}
	});

	bundleBtn.addEventListener("click", () => {
		event.target.classList.add("disabled");
		event.target.innerHTML = "Loading...";
		const bundle_price = event.target.getAttribute("data-price");
		checkoutData.line_items[0].price = bundle_price;
		purchase();
	});

	teacherBtn.addEventListener("click", () => {
		event.target.innerHTML = "Loading...";
		event.target.classList.add("disabled");
		const monthly_price = event.target.getAttribute("data-price-monthly");
		const yearly_price = event.target.getAttribute("data-price-annual");

		checkoutData.line_items[0].price = teacherMonthly ? monthly_price : yearly_price;
		purchase();
	});

	// TOGGLE MONTHLY / ANNUAL
	document.querySelector("#teacher-price-switch").addEventListener("click", (event) => {
		// Change to Yearly
		if (monthlyText.classList.contains("active")) {
			teacherMonthly = false;
			monthlyText.classList.remove("active");
			yearlyText.classList.add("active");
		}
		// Change to Monthly Pricing
		else {
			teacherMonthly = true;
			monthlyText.classList.add("active");
			yearlyText.classList.remove("active");
		}
	});

	async function purchase() {
		if (auth.currentUser && localStorage.getItem("uid")) {
			axios({
				method: "post",
				url: `${API_URL}/stripe/checkout`,
				data: checkoutData,
			})
				.then((response) => {
					if (response.data.url) window.location.href = response.data.url;
				})
				.catch((error) => {
					console.log(error);
				});
		} else {
			let url = new URL(LOGIN_URL, window.location.origin);
			url.searchParams.append("continueURL", CURRENT_PAGE_URL);
			window.location.href = url;
		}
	}
</script>
