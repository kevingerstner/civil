<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="module">
	import {
		getAuth,
		onAuthStateChanged,
	} from "https://www.gstatic.com/firebasejs/9.1.1/firebase-auth.js";

	const auth = getAuth();
	const apiURL = "https://us-central1-civil-ed.cloudfunctions.net/api";

	onAuthStateChanged(auth, async (user) => {
		if (user) {
			// Check if user is paid or not
			const idTokenResult = await user.getIdTokenResult(true);
			let admin = !!idTokenResult.claims.admin;
			if (!admin) window.location.replace("/");
		}
		if (!user) {
			window.location.replace("/");
		}
	});

	document.getElementById("provision-user").addEventListener("submit", provisionUser);
	document.getElementById("unprovision-user").addEventListener("submit", unprovisionUser);
	document.querySelector("#make-student").addEventListener("submit", makeStudent);
	document.querySelector("#make-teacher").addEventListener("submit", makeTeacher);
	document.getElementById("set-admin").addEventListener("submit", setAdmin);
	document.getElementById("revoke-admin").addEventListener("submit", revokeAdmin);
	document.getElementById("get-user-data").addEventListener("submit", getUserData);
	document.getElementById("get-user-data-email").addEventListener("submit", getUserDataEmail);
	document.querySelector("#add-tag-to-subscriber").addEventListener("submit", addTagToSubscriber);
	document
		.querySelector("#remove-tag-from-subscriber")
		.addEventListener("submit", removeTagFromSubscriber);

	/** ADMIN **/

	async function setAdmin(event) {
		const email = event.target.querySelector(".form_field").value;
		sendAdminRequest(event, "/admin/grantAdmin", "post", { email }, null);
	}

	async function revokeAdmin(event) {
		const email = event.target.querySelector(".form_field").value;
		sendAdminRequest(event, "/admin/revokeAdmin", "post", { email }, null);
	}

	/** USER **/

	async function provisionUser(event) {
		const email = event.target.querySelector(".form_field").value;
		sendAdminRequest(event, "/admin/provisionUser", "post", { user: email }, null);
	}

	async function unprovisionUser(event) {
		const email = event.target.querySelector(".form_field").value;
		sendAdminRequest(event, "/admin/unprovisionUser", "post", { user: email }, null);
	}

	async function makeStudent(event) {
		const email = event.target.querySelector(".form_field").value;
		sendAdminRequest(event, "/admin/makeStudent", "post", { user: email }, null);
	}

	async function makeTeacher(event) {
		const email = event.target.querySelector(".form_field").value;
		sendAdminRequest(event, "/admin/makeTeacher", "post", { user: email }, null);
	}

	async function getUserData(event) {
		const uid = event.target.querySelector(".form_field").value;
		sendAdminRequest(event, "/admin/user", "get", null, { uid });
	}

	async function getUserDataEmail(event) {
		const email = event.target.querySelector(".form_field").value;
		sendAdminRequest(event, "/admin/user", "get", null, { email });
	}

	/** MAILCHIMP **/

	async function addTagToSubscriber(event) {
		const email = event.target.elements["email"].value;
		const tagName = event.target.elements["tagName"].value;
		sendAdminRequest(event, "/mailchimp/addTag", "post", { email, tagName }, null);
	}

	async function removeTagFromSubscriber(event) {
		const email = event.target.elements["email"].value;
		const tagName = event.target.elements["tagName"].value;
		sendAdminRequest(event, "/mailchimp/removeTag", "post", { email, tagName }, null);
	}

	async function sendAdminRequest(event, endpoint, method, data, params, local) {
		event.preventDefault();
		event.stopPropagation();
		const formMessageBox = event.target.querySelector(".form-message_box");
		const message = formMessageBox.querySelector(".message");
		formMessageBox.style.display = "none";
		const user = auth.currentUser;
		let token = user && (await user.getIdToken(true));
		axios({
			method,
			url: (local ? "http://localhost:5001/civil-ed/us-central1/api" : apiURL) + endpoint,
			headers: {
				Authorization: `Bearer ${token}`,
			},
			data,
			params,
		})
			.then((res) => {
				message.innerText = JSON.stringify(res.data, null, 4);
				formMessageBox.style.display = "block";
			})
			.catch((err) => {
				message.innerText = err.message;
				formMessageBox.style.display = "block";
			});
	}
</script>
